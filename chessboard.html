<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chess Board</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div data-component="wrapper"></div>
  <div data-component="controls">
    <form data-component="move-form">
      <input name="move-selected" type="text" />
      <input type="submit" value="Submit" />
    </form>
    <div class="move-console"></div>
  </div>
  <script type="module">
    import {
      generateChessBoard,
      renderToHtml,
      movePiece,
      validateMove,
      _getPosition
    } from "./lib/chessboard.js";
    import { rookValidMoves } from './lib/rook.js';

    const wrapper = document.querySelector("[data-component=wrapper]");

    const history = [];
    const startingBoard = generateChessBoard();
    history.push(startingBoard);
    const table = renderToHtml(startingBoard);
    wrapper.appendChild(table);

    const moveForm = document.querySelector("[data-component=move-form]");
    const moveInput = document.getElementsByName("move-selected")[0];
    const moveConsole = document.querySelector(".move-console");

    const movePieceViaForm = event => {
      event.preventDefault();

      const coordinates = moveInput.value.split("").map(Number);
      console.log(coordinates)
      const startPosition = coordinates.slice(0, 2);
      const endPosition = coordinates.slice(2, 4);
      const currentBoard = history[history.length - 1];

      // try / catch to try the validation and catch an error object, use the error.message to populate the div
      // this makes validateMove == assertion func
      const invalidMove = validateMove(
        currentBoard,
        coordinates
      );
      if (invalidMove) {
        return (moveConsole.innerHTML += `<div class="error">${invalidMove}</div>`);
      }

      const currentSquare = _getPosition(currentBoard, startPosition[0], startPosition[1])
      const currentPiece = currentSquare.piece

      if (currentPiece.type === 'rook' && !rookValidMoves(currentBoard, currentSquare).includes(_getPosition(currentBoard, endPosition[0], endPosition[1]))) {
        return (moveConsole.innerHTML += `<div class="error">Error: ${startPosition} -> ${endPosition} is not a valid move for a rook!</div>`);
      }

      if (currentPiece.type !== 'rook' || rookValidMoves(currentBoard, currentSquare).includes(_getPosition(currentBoard, endPosition[0], endPosition[1]))) {
        const newBoard = movePiece(
          currentBoard,
          startPosition,
          endPosition
        );
        history.push(newBoard);
        wrapper.innerHTML = "";
        moveInput.value = "";
        const newTable = renderToHtml(newBoard);
        wrapper.appendChild(newTable);
        wrapper.appendChild(moveForm);

        moveConsole.innerHTML += `<div class="success">Successful move: [${startPosition}, ${endPosition}]</div>`;
      }
    }

    moveForm.addEventListener("submit", movePieceViaForm);
    // move piece via the console by calling this function with two arrays for start and end position:
    // window.movePiece = (startPosition, endPosition) => {
    //   const newBoard = movePiece(
    //     history[history.length - 1],
    //     startPosition,
    //     endPosition
    //   );
    //   history.push(newBoard);
    //   wrapper.innerHTML = "";
    //   const newTable = renderToHtml(newBoard);
    //   wrapper.appendChild(newTable);
    // };
  </script>
</body>

</html>

<!-- Serve the page with http-server and letting it default to the correct file -->
<!-- Initial console version - move a piece by calling `window.movePiece([1,1],[4,4])` -->